# PFR-AI: Бэкенд

Серверная часть приложения для анализа пенсионных дел, написанная на FastAPI.

## Функциональность

*   Принимает данные пенсионного дела в формате JSON.
*   Производит валидацию данных с использованием Pydantic.
*   **Запускает модель классификации для определения возможных ошибок.**
*   **Предоставляет RAG-систему для анализа дела на соответствие законодательству (ФЗ-400):**
    *   Использует LlamaIndex, Ollama (LLM и эмбеддинги).
    *   Индексирует PDF-документ закона при первом запуске.
    *   Использует иерархический чанкинг и фильтрацию по метаданным.
*   Возвращает список найденных ошибок или текстовый результат RAG-анализа.
*   **Хранит историю обработанных дел в базе данных SQLite** (используя SQLAlchemy).
*   Предоставляет эндпоинт для получения истории.
*   **Генерирует документы (PDF/DOCX)** с результатами анализа (базового).

## API Эндпоинты

*   **`POST /process`**:
    *   Принимает: Тело запроса с данными дела (`CaseDataInput` из `models.py`).
    *   Выполняет: Анализ ошибок с помощью классификатора, сохраняет дело в БД.
    *   Возвращает: JSON с полем `errors`, содержащим список объектов ошибок (`ErrorOutput` из `models.py`).
*   **`POST /api/v1/analyze_case`**:
    *   Принимает: JSON вида `{"case_description": "..."}` (`CaseAnalysisRequest`).
    *   Выполняет: Запрос к RAG-системе с переданным описанием.
    *   Возвращает: JSON вида `{"analysis_result": "..."}` (`CaseAnalysisResponse`) с текстовым ответом от RAG.
*   **`GET /history`**:
    *   Принимает: Необязательный query-параметр `limit` (по умолчанию 100).
    *   Возвращает: Список последних обработанных дел (массив объектов `CaseHistoryEntry` из `models.py`) из базы данных.
*   **`GET /download_document/{case_id}`**:
    *   Принимает: Path-параметр `case_id` (ID дела) и query-параметр `format` (`pdf` или `docx`).
    *   Возвращает: Сгенерированный файл (PDF или DOCX) с базовыми ошибками.
*   **`GET /`**: Возвращает статусное сообщение.

## Установка и запуск

1.  **Требования:**
    *   Python 3.9+.
    *   **Установленный и запущенный Ollama** с необходимыми моделями (например, `gemma3`, `mxbai-embed-large`), доступный по `http://localhost:11434`.
2.  Перейдите в директорию `backend`:
    ```bash
    cd backend
    ```
3.  **Виртуальное окружение:**
    ```bash
    python -m venv venv
    # Windows: .\venv\Scripts\activate
    # macOS/Linux: source ./venv/bin/activate
    ```
4.  **Установка зависимостей:**
    ```bash
    pip install -r requirements.txt
    ```
    Основные зависимости:
    *   `fastapi`: Веб-фреймворк.
    *   `uvicorn[standard]`: ASGI сервер.
    *   `pydantic`: Валидация данных.
    *   `sqlalchemy[asyncio]`: ORM для работы с БД.
    *   `aiosqlite`: Асинхронный драйвер для SQLite.
    *   `llama-index`, `llama-index-llms-ollama`, `llama-index-embeddings-ollama`: Для RAG.
    *   `sentence-transformers`, `scikit-learn`, `pandas`, `nltk`: Для классификатора ошибок (и его возможных зависимостей).
    *   `python-docx`, `reportlab`: Для генерации DOCX и PDF.
5.  **Индексация RAG (первый запуск):** При первом запуске сервера произойдет автоматическая индексация PDF документа из папки `data/`. Это может занять **значительное время** (несколько минут). Следите за логами.
6.  **Запуск сервера:**
    ```bash
    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    ```
    *   Сервер будет доступен по адресу `http://127.0.0.1:8000`.
    *   Интерактивная документация API (Swagger UI) будет доступна по адресу `http://127.0.0.1:8000/docs`.

## Структура кода

*   `app/main.py`: Основной файл FastAPI, определяет приложение, `lifespan` (для инициализации RAG и классификатора), роутеры и эндпоинты.
*   `app/models.py`: Содержит Pydantic модели для данных, ошибок и истории.
*   `app/rag_core/`: Модуль для RAG.
    *   `query_engine.py`: Логика инициализации индекса, чанкинга, фильтрации и выполнения RAG-запросов.
    *   `loader.py`: Загрузка документов для индексации.
*   `app/database.py`: Настройка SQLAlchemy (асинхронный движок, сессии).
*   `app/crud.py`: Функции для взаимодействия с базой данных (Create, Read, Update, Delete).
*   `app/services.py`: Сервисный слой, например, для генерации документов.
*   `error_classifier.py`: Модуль с классом для классификации ошибок.
*   `data/`: Папка для данных (PDF закона, файлы индекса RAG, БД SQLite).
*   `requirements.txt`: Список зависимостей Python. 