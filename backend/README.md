# PFR-AI: Бэкенд Анализа Пенсионных Дел

[![Python Version](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![Framework](https://img.shields.io/badge/framework-FastAPI-green.svg)](https://fastapi.tiangolo.com/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

Серверная часть приложения для интеллектуального анализа данных пенсионных дел, построенная на FastAPI.

Подробный перечень всех используемых технологий можно найти в [главном файле стека проекта](../TECHNOLOGIES.md).

## Основные Возможности

*   **Современный API:** Асинхронный RESTful API на базе FastAPI с валидацией данных через Pydantic.
*   **Аутентификация и Авторизация:** Безопасная система на основе OAuth2 и JWT с разделением ролей (администратор, менеджер).
*   **Управление Делами:** Полный CRUD-функционал для управления пенсионными делами, включая создание, получение статуса, чтение и удаление.
*   **Анализ с помощью RAG:** Продвинутая система Retrieval-Augmented Generation (RAG) на базе LlamaIndex для анализа дел на соответствие законодательству.
    *   Использует локально запущенный Ollama для генерации текста (LLM) и анализа изображений (Vision).
    *   Автоматически индексирует нормативные документы (PDF) из папки `data/` при первом запуске.
*   **Извлечение данных из документов (Vision):** Асинхронная обработка изображений документов (паспорта, СНИЛС, трудовые книжки и др.) для извлечения структурированных данных с помощью мультимодальных моделей.
*   **Управление Базой Знаний:** API для управления документами, используемыми RAG-системой.
*   **Фоновые Задачи:** Выполнение длительных операций (RAG-анализ, OCR/Vision) в фоновом режиме без блокировки API.
*   **Хранение Данных:** Сохранение информации о делах, пользователях и задачах в базе данных SQLite с использованием асинхронного SQLAlchemy.
*   **База Знаний (Граф):** Интеграция с графовой базой данных Neo4j для построения и обогащения графа знаний на основе нормативных документов.
*   **Генерация Отчетов:** Создание отчетов по пенсионным делам в форматах PDF и DOCX.
*   **Конфигурация:** Гибкая настройка через JSON-файлы и переменные окружения.

## API

Полная интерактивная документация (Swagger UI) доступна по адресу `/docs`, а альтернативная (ReDoc) — по адресу `/redoc` после запуска сервера.

Подробное статическое описание всех эндпоинтов, моделей и примеров запросов находится в файле [**`api.md`**](./api.md).

### Краткий обзор эндпоинтов

*   **`/api/v1/auth`**: Аутентификация и получение JWT-токенов.
*   **`/api/v1/users`**: Управление пользователями (получение данных о себе).
*   **`/api/v1/pension_types`**: Получение справочника по типам пенсий.
*   **`/api/v1/pension_documents`**: Получение справочника требуемых документов для типа пенсии.
*   **`/api/v1/cases`**: CRUD-операции для пенсионных дел.
*   **`/api/v1/document_extractions`**: Асинхронная загрузка и анализ изображений документов.
*   **`/api/v1/documents`**: Управление документами в базе знаний RAG.
*   **`/api/v1/health`**: Проверка состояния работоспособности сервиса и его зависимостей.

## Установка и Запуск

1.  **Клонирование репозитория:**
    ```bash
    git clone <your-repo-url>
    cd PFR-AI/backend
    ```

2.  **Требования:**
    *   Python 3.9 или выше.
    *   **Ollama:** Установленный и запущенный Ollama (см. [https://ollama.com/](https://ollama.com/)).
    *   **Модели для Ollama:** Убедитесь, что необходимые LLM скачаны (актуальные модели см. в `backend/app/rag_core/config.py` и `backend/app/vision_services.py`):
        ```bash
        # Пример моделей, которые могут потребоваться
        ollama pull qwen2:7b-instruct-q8_0 
        ollama pull llava:13b-v1.6-q8_0
        ```
        Ollama должен быть доступен по адресу `http://localhost:11434` (стандартный).
    *   **Neo4j:** Установленная и запущенная графовая база данных Neo4j.

3.  **Виртуальное окружение:**
    ```bash
    python -m venv venv
    # Windows
    .\venv\Scripts\activate
    # macOS/Linux
    source ./venv/bin/activate
    ```

4.  **Установка зависимостей:**
    *Примечание: Установка зависимостей, особенно `torch` и связанных с ним библиотек, может занять время и потребовать значительного дискового пространства.*
    ```bash
    pip install -r requirements.txt
    ```

5.  **Конфигурация:**
    *   Основные параметры (имена моделей, пути, подключение к БД) настраиваются в `backend/app/rag_core/config.py` и других файлах конфигурации.
    *   Для переопределения настроек рекомендуется использовать переменные окружения. Создайте файл `.env` в папке `backend/`:
      ```dotenv
      # Пример .env файла
      SECRET_KEY="your-super-secret-key-for-jwt"
      OLLAMA_BASE_URL="http://localhost:11434"
      LOGGING_LEVEL="INFO"
      
      # Данные для подключения к Neo4j
      NEO4J_URI="bolt://localhost:7687"
      NEO4J_USER="neo4j"
      NEO4J_PASSWORD="your_neo4j_password"
      NEO4J_DATABASE="neo4j"
      
      # Учетные данные для создания первого администратора
      ADMIN_USERNAME="admin"
      ADMIN_PASSWORD="adminPas"
      ```

6.  **Инициализация:**
    *   **База данных:** При первом запуске будет создан файл базы данных `cases.db`.
    *   **Первый пользователь:** Запустите скрипт для создания начальных пользователей (администратора и менеджера):
        ```bash
        python create_initial_users.py
        ```
    *   **Индексация RAG:** При первом запуске сервера будет выполнена индексация PDF-документов из папки `backend/data/`. Это **необходимо** для работы RAG-системы и может занять **значительное время** (от нескольких минут до десятков минут в зависимости от объема документов и мощности системы).
    *   Следите за логами сервера для отслеживания прогресса. Файлы индекса будут сохранены в `backend/data/storage/`.

7.  **Запуск сервера:**
    Для разработки используйте `uvicorn` с горячей перезагрузкой:
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ```