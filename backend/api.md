# API Документация для Frontend Разработки "Пенсионного Консультанта"

## Оглавление

1.  [Введение](#1-введение)
2.  [Базовый URL](#2-базовый-url)
3.  [Аутентификация](#3-аутентификация)
4.  [Форматы Данных](#4-форматы-данных)
5.  [Обработка Ошибок](#5-обработка-ошибок)
6.  [Основные Сущности (Модели Данных)](#6-основные-сущности-модели-данных)
    *   [PersonalData](#personaldata)
    *   [DisabilityInfo](#disabilityinfo)
    *   [WorkExperience](#workexperience)
    *   [OtherDocumentData](#otherdocumentdata)
    *   [CaseDataInput](#casedatainput)
    *   [ProcessOutput](#processoutput)
    *   [CaseHistoryEntry](#casehistoryentry)
    *   [FullCaseData](#fullcasedata)
    *   [OcrTaskSubmitResponse](#ocrtasksubmitresponse)
    *   [OcrTaskStatusResponse](#ocrtaskstatusresponse)
    *   [TasksStatsResponse](#tasksstatsresponse)
    *   [DocumentDetail](#documentdetail)
    *   [HealthCheckResponse](#healthcheckresponse)
    *   [User (для информации о пользователе)](#user)
    *   [Token (для ответа при логине)](#token)
7.  [Эндпоинты API](#7-эндпоинты-api)
    *   [Аутентификация](#аутентификация-эндпоинты)
        *   [POST /api/v1/auth/token](#post-apiv1authtoken)
        *   [GET /api/v1/users/me](#get-apiv1usersme)
    *   [Конфигурация и Справочники](#конфигурация-и-справочники)
        *   [GET /api/v1/pension_types](#get-apiv1pension_types)
        *   [GET /api/v1/pension_documents/{pension_type_id}](#get-apiv1pension_documentspension_type_id)
        *   [GET /api/v1/standard_document_names](#get-apiv1standard_document_names)
    *   [Работа с Делами (Cases)](#работа-с-делами-cases)
        *   [POST /api/v1/cases](#post-apiv1cases)
        *   [GET /api/v1/cases/{case_id}/status](#get-apiv1casescase_idstatus)
        *   [GET /api/v1/cases/{case_id}](#get-apiv1casescase_id)
        *   [GET /api/v1/cases/history](#get-apiv1caseshistory)
        *   [GET /api/v1/cases/{case_id}/document](#get-apiv1casescase_iddocument)
    *   [Извлечение Данных из Документов (OCR/Vision)](#извлечение-данных-из-документов-ocrvision)
        *   [POST /api/v1/document_extractions](#post-apiv1document_extractions)
        *   [GET /api/v1/document_extractions/{task_id}](#get-apiv1document_extractionstask_id)
        *   [GET /api/v1/tasks/stats](#get-apiv1tasksstats)
    *   [Служебные Эндпоинты](#служебные-эндпоинты)
        *   [GET /](#get-)
        *   [GET /api/v1/health](#get-apiv1health)
8.  [Фоновые Задачи](#8-фоновые-задачи)
9.  [Важные Замечания для Frontend](#9-важные-замечания-для-frontend)

---

## 1. Введение

Эта документация описывает API бэкенда для приложения "Пенсионный Консультант". API позволяет управлять пенсионными делами, обрабатывать документы и получать справочную информацию.

## 2. Базовый URL

Все запросы к API должны использовать базовый URL вашего развернутого бэкенд-сервиса. Например: `http://localhost:8000` (для локальной разработки).

## 3. Аутентификация

API использует **OAuth2 Password Flow** с **JWT (JSON Web Tokens)** для аутентификации пользователей.

**Процесс получения токена:**

1.  Клиент отправляет POST-запрос на эндпоинт `/api/v1/auth/token`.
2.  В теле запроса передаются `username` и `password` в формате `application/x-www-form-urlencoded` (стандарт для OAuth2PasswordRequestForm).
3.  В случае успеха сервер возвращает `access_token` и `token_type` ("bearer").
4.  Пример запроса (используя curl или HTTP-клиент):
    ```bash
    curl -X POST "http://localhost:8000/api/v1/auth/token" \\
         -H "Content-Type: application/x-www-form-urlencoded" \\
         -d "username=your_username&password=your_password"
    ```
5.  Пример успешного ответа:
    ```json
    {
      "access_token": "your_jwt_token_here",
      "token_type": "bearer"
    }
    ```

**Использование токена:**

*   Полученный `access_token` должен передаваться в заголовке `Authorization` каждого запроса к защищенным эндпоинтам.
*   Формат заголовка: `Authorization: Bearer <your_jwt_token_here>`

**Срок жизни токена:**

*   По умолчанию, токен доступа действителен в течение 30 минут. Это значение может быть изменено в конфигурации сервера.

**Защищенные эндпоинты:**

*   Большинство эндпоинтов API теперь требуют аутентификации и соответствующей роли пользователя (admin или manager).
*   Если токен отсутствует, недействителен или у пользователя нет прав доступа, сервер вернет ошибку `401 Unauthorized` или `403 Forbidden`.

**Роли пользователей:**

*   **admin**: Имеет полный доступ ко всем функциям системы.
*   **manager**: Имеет доступ к большинству операций, связанных с управлением делами и документами, но не к административным функциям.
    *   Администратор автоматически имеет все права менеджера.

**Для входа используйте следующие учетные данные (по умолчанию, если не изменены через переменные окружения при запуске `create_initial_users.py`):**

*   **Администратор:**
    *   Логин: `admin`
    *   Пароль: `adminPas`
*   **Менеджер:**
    *   Логин: `manager`
    *   Пароль: `managerPas`

## 4. Форматы Данных

API использует JSON для обмена данными в телах запросов и ответов.
Для загрузки файлов (например, изображений документов) используется `multipart/form-data`.

## 5. Обработка Ошибок

API использует стандартные HTTP статусы для индикации ошибок.

*   **2xx**: Успех
*   **400 Bad Request**: Некорректный запрос (например, отсутствуют обязательные поля, неверный формат данных, не соответствующий MIME-тип файла).
*   **404 Not Found**: Запрошенный ресурс не найден (например, дело с указанным ID).
*   **413 Payload Too Large**: Размер загружаемого файла превышает лимит.
*   **422 Unprocessable Entity**: Ошибка валидации данных (например, неверный формат СНИЛС, дата рождения в будущем). Тело ответа будет содержать подробности:
    ```json
    {
      "detail": [
        {
          "loc": ["body", "personal_data", "snils"],
          "msg": "Номер СНИЛС должен содержать 11 цифр",
          "type": "value_error"
        }
      ]
    }
    ```
    Или, для новых стандартизированных ошибок:
    ```json
    {
        "error_code": "VALIDATION_ERROR",
        "message": "Ошибка валидации входных данных.",
        "details": [
            {
                "field": "body.personal_data.snils",
                "message": "Номер СНИЛС должен содержать 11 цифр",
                "type": "value_error"
            }
        ]
    }
    ```
*   **500 Internal Server Error**: Внутренняя ошибка сервера. Тело ответа может содержать сообщение об ошибке.
*   **503 Service Unavailable**: Сервис временно недоступен (например, не загружена конфигурация, недоступна внешняя LLM).
*   **504 Gateway Timeout**: Таймаут при обращении к внешнему сервису (например, Ollama).

Стандартизированный формат ответа для ошибок (если используется модель `StandardErrorResponse`):
```json
{
    "error_code": "КОД_ОШИБКИ",
    "message": "Человекочитаемое сообщение об ошибке",
    "details": { /* специфичные для ошибки детали */ }
}
```

## 6. Основные Сущности (Модели Данных)

Ниже описаны ключевые модели данных, используемые в API.

### PersonalData

Информация о заявителе.

| Поле               | Тип                           | Обязательное | Описание                                                                    | Ограничения/Валидация                                                                                                                                                              |
| ------------------ | ----------------------------- | ------------ | --------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `last_name`        | string                        | Да           | Фамилия                                                                     |                                                                                                                                                                                    |
| `first_name`       | string                        | Да           | Имя                                                                         |                                                                                                                                                                                    |
| `middle_name`      | string \| null                | Нет          | Отчество                                                                    |                                                                                                                                                                                    |
| `birth_date`       | string (date, `YYYY-MM-DD`)   | Да           | Дата рождения                                                               | Не может быть в будущем.                                                                                                                                                           |
| `snils`            | string                        | Да           | Номер СНИЛС                                                                 | Должен содержать 11 цифр. Может быть введен с пробелами/дефисами, но на бэкенде будет нормализован.                                                                                   |
| `gender`           | string                        | Да           | Пол (например, "Мужской", "Женский")                                        |                                                                                                                                                                                    |
| `citizenship`      | string                        | Да           | Гражданство                                                                 |                                                                                                                                                                                    |
| `name_change_info` | [NameChangeInfo](#namechangeinfo) \| null | Нет          | Информация о смене ФИО                                                      |                                                                                                                                                                                    |
| `dependents`       | integer                       | Да           | Количество иждивенцев                                                       | `>= 0`                                                                                                                                                                             |

### NameChangeInfo

Информация о смене ФИО.

| Поле            | Тип                         | Обязательное | Описание           |
| --------------- | --------------------------- | ------------ | ------------------ |
| `old_full_name` | string \| null              | Нет          | Предыдущее полное ФИО |
| `date_changed`  | string (date, `YYYY-MM-DD`) \| null | Нет          | Дата смены ФИО     |

### DisabilityInfo

Информация об инвалидности.

| Поле          | Тип                         | Обязательное | Описание                | Ограничения/Валидация                                       |
| ------------- | --------------------------- | ------------ | ----------------------- | ----------------------------------------------------------- |
| `group`       | string                      | Да           | Группа инвалидности     | "1", "2", "3", "child"                                      |
| `date`        | string (date, `YYYY-MM-DD`) | Да           | Дата установления       |                                                             |
| `cert_number` | string \| null              | Нет          | Номер справки МСЭ (БМСЭ) |                                                             |

### WorkExperienceRecord

Одна запись о трудовом стаже.

| Поле                 | Тип                         | Обязательное | Описание                                                                                               | Ограничения/Валидация                                |
| -------------------- | --------------------------- | ------------ | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------------- |
| `organization`       | string                      | Да           | Наименование организации                                                                               |                                                      |
| `position`           | string                      | Да           | Должность                                                                                              |                                                      |
| `start_date`         | string (date, `YYYY-MM-DD`) | Да           | Дата начала работы                                                                                     |                                                      |
| `end_date`           | string (date, `YYYY-MM-DD`) | Да           | Дата окончания работы                                                                                  | Не может быть раньше `start_date`.                   |
| `special_conditions` | boolean \| null             | Нет          | Наличие особых условий труда (влияет на льготный стаж). По умолчанию `false`.                             |                                                      |

### WorkExperience

Информация о трудовом стаже.

| Поле          | Тип                                       | Обязательное | Описание             | Ограничения/Валидация |
| ------------- | ----------------------------------------- | ------------ | -------------------- | --------------------- |
| `total_years` | integer                                   | Да           | Общий стаж в годах  | `>= 0`                |
| `records`     | Array<[WorkExperienceRecord](#workexperiencerecord)> \| null | Нет          | Список записей о стаже |                       |

### OtherDocumentData

Структурированные данные, извлеченные из дополнительно загруженного документа (не паспорт, СНИЛС, трудовая).

| Поле                           | Тип            | Обязательное | Описание                                                                                                                                                                                                                                                                                                   |
| ------------------------------ | -------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `identified_document_type`     | string \| null | Нет          | Тип документа, определенный мультимодальной LLM (например, 'Свидетельство о рождении', 'Договор').                                                                                                                                                                                                       |
| `standardized_document_type`   | string \| null | Нет          | Стандартизированный тип документа, если он совпадает с известным типом пенсионных документов (выбран из списка, полученного от `/api/v1/standard_document_names`). Если LLM не смогла подобрать, может быть `null`.                                                                                          |
| `extracted_fields`             | object \| null | Нет          | Извлеченные поля из документа в формате ключ-значение (например, `{"ФИО ребенка": "Петров Петр Петрович", "Дата рождения": "2000-01-01"}`).                                                                                                                                                              |
| `multimodal_assessment`        | string \| null | Нет          | Оценка документа мультимодальной LLM (качество, читаемость, полнота; например, "Хорошее качество, текст четкий").                                                                                                                                                                                         |
| `text_llm_reasoning`           | string \| null | Нет          | Дополнительный анализ или "осмысление" от текстовой LLM на основе данных от мультимодальной LLM. Включает оценку корректности извлечения, полноты и более глубокий анализ содержания. Не включает в себя стандартизированный тип (он в отдельном поле).                                                      |

### CaseDataInput

Основная модель для создания или обновления дела.

| Поле                               | Тип                                     | Обязательное | Описание                                                                                                                                  |
| ---------------------------------- | --------------------------------------- | ------------ | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `personal_data`                    | [PersonalData](#personaldata)           | Да           | Персональные данные заявителя.                                                                                                            |
| `pension_type`                     | string                                  | Да           | Тип запрашиваемой пенсии. Должен быть одним из ID, полученных от `/api/v1/pension_types`.                                                     |
| `disability`                       | [DisabilityInfo](#disabilityinfo) \| null | Нет          | Информация об инвалидности (если применимо).                                                                                             |
| `work_experience`                  | [WorkExperience](#workexperience) \| null | Нет          | Информация о трудовом стаже (если применимо).                                                                                             |
| `pension_points`                   | float \| null                           | Нет          | Количество пенсионных баллов (ИПК).                                                                                                       |
| `benefits`                         | Array<string> \| null                   | Нет          | Список кодов или описаний льгот.                                                                                                          |
| `submitted_documents`              | Array<string> \| null                   | Нет          | Список ID представленных стандартных документов (ID из конфигурации, получаемой через `/api/v1/pension_documents/{pension_type_id}`).          |
| `has_incorrect_document`           | boolean \| null                         | Нет          | Флаг, указывающий на наличие некорректно оформленных документов. По умолчанию `false`.                                                         |
| `other_documents_extracted_data`   | Array<[OtherDocumentData](#otherdocumentdata)> \| null | Нет          | Список данных, извлеченных из дополнительно загруженных (не стандартных) документов. Заполняется на основе результатов OCR/Vision. |

### ProcessOutput

Модель ответа для эндпоинтов, связанных с обработкой дела.

| Поле               | Тип                           | Описание                                                                                                                                                             |
| ------------------ | ----------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `case_id`          | integer                       | ID созданного или обновленного дела.                                                                                                                                 |
| `final_status`     | string                        | Итоговый статус обработки. Возможные значения: "PROCESSING", "COMPLETED", "FAILED", "ERROR_PROCESSING", "СООТВЕТСТВУЕТ", "НЕ СООТВЕТСТВУЕТ", "UNKNOWN".            |
| `explanation`      | string \| null                | Объяснение статуса, особенно если это результат RAG-анализа или ошибка.                                                                                               |
| `confidence_score` | float \| null                 | Оценка уверенности RAG-системы (от 0.0 до 1.0), если применимо.                                                                                                      |
| `department_code`  | string \| null                | Код подразделения, куда может быть направлено дело (пока не используется активно).                                                                                     |
| `error_info`       | [ErrorDetail](#errordetail) \| null | Детализированная информация об ошибке, если `final_status` указывает на ошибку (например, "ERROR_PROCESSING", "FAILED").                                       |

### ErrorDetail

Детализированная информация об ошибке.

| Поле      | Тип            | Описание                                                      |
| --------- | -------------- | ------------------------------------------------------------- |
| `code`    | string \| null | Код ошибки (например, "RAG_ERROR", "VALIDATION_ERROR")        |
| `message` | string \| null | Человекочитаемое сообщение об ошибке.                         |
| `source`  | string \| null | Источник ошибки (например, "RAG", "OCR", "DB")                |
| `details` | object \| null | Дополнительные детали, специфичные для ошибки (например, поля с ошибками валидации). |


### CaseHistoryEntry

Модель для представления записи в истории дел.

| Поле                | Тип                                   | Описание                                         |
| ------------------- | ------------------------------------- | ------------------------------------------------ |
| `id`                | integer                               | ID дела.                                         |
| `created_at`        | string (datetime, ISO 8601)           | Дата и время создания дела.                      |
| `pension_type`      | string                                | Тип запрашиваемой пенсии.                        |
| `final_status`      | string                                | Итоговый статус дела.                            |
| `final_explanation` | string \| null                        | Итоговое объяснение.                             |
| `rag_confidence`    | float \| null                         | Уверенность RAG-анализа.                         |
| `personal_data`     | [PersonalData](#personaldata) \| null | Персональные данные заявителя (могут отсутствовать). |

### FullCaseData

Модель для полной информации о деле. Включает все поля из `CaseDataInput`, а также:

| Поле                 | Тип                         | Описание                                                       |
| -------------------- | --------------------------- | -------------------------------------------------------------- |
| `id`                 | integer                     | ID дела.                                                       |
| `created_at`         | string (datetime, ISO 8601) | Дата и время создания дела.                                    |
| `updated_at`         | string (datetime, ISO 8601) \| null | Дата и время последнего обновления.                            |
| `errors`             | Array<object> \| null       | Список ошибок, сохраненных с делом (структура не детализирована в OpenAPI, но скорее всего это `List[Dict[str, Any]]`). |
| `final_status`       | string \| null              | Итоговый статус дела.                                          |
| `final_explanation`  | string \| null              | Итоговое объяснение.                                           |
| `rag_confidence`     | float \| null               | Уверенность RAG-анализа.                                       |
| ... (все поля из `CaseDataInput` с возможностью быть `null`, если данные не были предоставлены или были ошибки парсинга из БД) |

**Примечание:** Поля, хранящиеся в БД как JSON (например, `personal_data`, `disability`), при получении через этот эндпоинт будут десериализованы в соответствующие Pydantic-модели или словари/списки.

### PassportData

Структурированные данные, извлеченные из паспорта.

| Поле                | Тип                         | Описание                                                              |
| ------------------- | --------------------------- | --------------------------------------------------------------------- |
| `last_name`         | string \| null              | Фамилия                                                               |
| `first_name`        | string \| null              | Имя                                                                   |
| `middle_name`       | string \| null              | Отчество                                                              |
| `birth_date`        | string (date, `YYYY-MM-DD`) \| null | Дата рождения                                                         |
| `sex`               | string \| null              | Пол (например, "МУЖ.", "ЖЕН.")                                        |
| `birth_place`       | string \| null              | Место рождения (город, регион, страна)                                |
| `passport_series`   | string \| null              | Серия паспорта (4 цифры, например, "1234")                            |
| `passport_number`   | string \| null              | Номер паспорта (6 цифр, например, "567890")                           |
| `issue_date`        | string (date, `YYYY-MM-DD`) \| null | Дата выдачи паспорта                                                  |
| `issuing_authority` | string \| null              | Кем выдан паспорт                                                     |
| `department_code`   | string \| null              | Код подразделения, выдавшего паспорт (например, "770-001")            |

### SnilsData

Структурированные данные, извлеченные из СНИЛС.

| Поле           | Тип                         | Описание                                           |
| -------------- | --------------------------- | -------------------------------------------------- |
| `snils_number` | string \| null              | Номер СНИЛС в формате "XXX-XXX-XXX XX" или 11 цифр |
| `last_name`    | string \| null              | Фамилия (если есть на документе СНИЛС)             |
| `first_name`   | string \| null              | Имя (если есть на документе СНИЛС)                 |
| `middle_name`  | string \| null              | Отчество (если есть на документе СНИЛС)            |
| `gender`       | string \| null              | Пол (если есть на документе СНИЛС)                 |
| `birth_date`   | string (date, `YYYY-MM-DD`) \| null | Дата рождения (если есть на документе СНИЛС)       |
| `birth_place`  | string \| null              | Место рождения (если есть на документе СНИЛС)      |

### WorkBookRecordEntry

Одна запись о трудовой деятельности из трудовой книжки.

| Поле           | Тип                         | Описание                                                                |
| -------------- | --------------------------- | ----------------------------------------------------------------------- |
| `date_in`      | string (date, `YYYY-MM-DD`) \| null | Дата приема на работу.                                                  |
| `date_out`     | string (date, `YYYY-MM-DD`) \| null | Дата увольнения (если есть, иначе `null`).                              |
| `organization` | string \| null              | Наименование организации.                                               |
| `position`     | string \| null              | Должность (1-2 ключевых слова, например, "учитель математики", "бухгалтер"). |

### WorkBookData

Структурированные данные, извлеченные из трудовой книжки.

| Поле                     | Тип                                       | Описание                                                                                                             |
| ------------------------ | ----------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `records`                | Array<[WorkBookRecordEntry](#workbookrecordentry)> | Список записей о трудовой деятельности. По умолчанию пустой массив `[]`.                                         |
| `calculated_total_years` | float \| null                             | Общий стаж в годах, рассчитанный на основе извлеченных записей. Может быть `null`, если записи отсутствуют или неполны. |


### OcrTaskSubmitResponse

Ответ при успешной постановке задачи на OCR/Vision обработку.

| Поле      | Тип    | Значение по умолчанию      | Описание                                                           |
| --------- | ------ | -------------------------- | ------------------------------------------------------------------ |
| `task_id` | string | Генерируется UUID          | Уникальный идентификатор созданной задачи.                         |
| `status`  | string | "PROCESSING"               | Начальный статус задачи.                                           |
| `message` | string | "Документ принят..."     | Сообщение для пользователя.                                        |

### OcrTaskStatusResponse

Ответ при запросе статуса OCR/Vision задачи.

| Поле      | Тип            | Описание                                                                                               |
| --------- | -------------- | ------------------------------------------------------------------------------------------------------ |
| `task_id` | string         | Идентификатор задачи.                                                                                  |
| `status`  | string         | Текущий статус задачи: "PROCESSING", "COMPLETED", "FAILED".                                            |
| `data`    | object \| null | Результат обработки, если `status` = "COMPLETED". Структура зависит от `document_type` при создании задачи: [PassportData](#passportdata), [SnilsData](#snilsdata), [WorkBookData](#workbookdata) или [OtherDocumentData](#otherdocumentdata). |
| `error`   | object \| null | Информация об ошибке, если `status` = "FAILED". Например, `{"detail": "Сообщение", "type": "ИмяОшибки"}`. |

### TasksStatsResponse

Статистика по задачам OCR/Vision.

| Поле                   | Тип            | Описание                                                                             |
| ---------------------- | -------------- | ------------------------------------------------------------------------------------ |
| `total`                | integer        | Общее количество задач в системе.                                                    |
| `pending`              | integer        | Количество задач в статусе "PROCESSING", которые еще не просрочены.                 |
| `expired_processing`   | integer        | Количество задач в статусе "PROCESSING", у которых истек срок жизни (TTL).             |
| `status_specific_counts` | object         | Словарь, где ключ - это статус ("PROCESSING", "COMPLETED", "FAILED"), а значение - количество задач с этим статусом. |

### DocumentDetail

Модель для описания требуемых документов для определенного типа пенсии.

| Поле             | Тип            | Описание                                                                   |
| ---------------- | -------------- | -------------------------------------------------------------------------- |
| `id`             | string         | Уникальный идентификатор документа в системе.                              |
| `name`           | string         | Человекочитаемое название документа.                                       |
| `description`    | string         | Подробное описание документа.                                              |
| `is_critical`    | boolean        | Является ли документ критически важным для данного типа пенсии.           |
| `condition_text` | string \| null | Текстовое описание условия, при котором этот документ требуется (если есть). |
| `ocr_type`       | string \| null | Предполагаемый тип документа для OCR (`passport`, `snils`, `work_book`, `other`), если его нужно распознавать. |

### HealthCheckResponse

Ответ эндпоинта проверки работоспособности системы.

| Поле             | Тип                                     | Описание                                                                                                                              |
| ---------------- | --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| `overall_status` | string                                  | Общий статус системы ("healthy" или "unhealthy").                                                                                     |
| `timestamp`      | string (datetime, ISO 8601)           | Время проверки.                                                                                                                       |
| `dependencies`   | Array<[DependencyStatus](#dependencystatus)> | Список статусов зависимостей (БД, Ollama LLM, Ollama Vision, Neo4j).                                                                  |

### DependencyStatus

Статус отдельной зависимости.

| Поле      | Тип            | Описание                                           |
| --------- | -------------- | -------------------------------------------------- |
| `name`    | string         | Имя зависимости (например, "database", "Ollama_LLM"). |
| `status`  | string         | Статус ("ok", "error", "skipped").                 |
| `message` | string \| null | Сообщение о статусе или ошибке.                    |

### User

Модель для представления информации о пользователе (например, в ответе на `/api/v1/users/me`).

| Поле        | Тип     | Описание                                       |
| ----------- | ------- | ---------------------------------------------- |
| `id`        | integer | Уникальный идентификатор пользователя.         |
| `username`  | string  | Имя пользователя (логин).                      |
| `role`      | string  | Роль пользователя ("admin" или "manager").       |
| `is_active` | boolean | Активен ли пользователь (всегда `true` для `get_current_user_data`). |

### Token

Модель ответа при успешной аутентификации.

| Поле           | Тип    | Описание                                           |
| -------------- | ------ | -------------------------------------------------- |
| `access_token` | string | JWT токен доступа.                                 |
| `token_type`   | string | Тип токена (всегда "bearer").                      |

---

## 7. Эндпоинты API

### Аутентификация (Эндпоинты)

#### POST /api/v1/auth/token

*   **Описание**: Аутентифицирует пользователя и возвращает JWT токен доступа.
*   **Тело запроса**: `application/x-www-form-urlencoded`
    *   `username` (string, обязательный): Имя пользователя.
    *   `password` (string, обязательный): Пароль.
*   **Ответ (200 OK)**: [Token](#token)
    ```json
    {
      "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "token_type": "bearer"
    }
    ```
*   **Ответ (401 Unauthorized)**: Неверные учетные данные.
    ```json
    {
      "detail": "Incorrect username or password"
    }
    ```
*   **Ответ (400 Bad Request)**: Пользователь неактивен.
    ```json
    {
        "detail": "Inactive user"
    }
    ```

#### GET /api/v1/users/me

*   **Описание**: Возвращает информацию о текущем аутентифицированном пользователе.
*   **Заголовки**:
    *   `Authorization: Bearer <your_jwt_token_here>`
*   **Ответ (200 OK)**: [User](#user)
    ```json
    {
      "id": 1,
      "username": "admin_user",
      "role": "admin",
      "is_active": true
    }
    ```
*   **Ответ (401 Unauthorized)**: Токен отсутствует, недействителен или истек.

### Конфигурация и Справочники

#### GET /api/v1/pension_types

*   **Описание**: Возвращает список всех доступных для выбора типов пенсий.
*   **Параметры**: Нет.
*   **Ответ (200 OK)**:
    ```json
    [
      {
        "id": "retirement_standard",
        "display_name": "Страховая пенсия по старости (общие основания)",
        "description": "Назначается при достижении общеустановленного пенсионного возраста, наличии необходимого страхового стажа и ИПК."
      },
      // ... другие типы пенсий
    ]
    ```
    Каждый объект в массиве содержит:
    *   `id` (string): Уникальный идентификатор типа пенсии (используется в `CaseDataInput.pension_type`).
    *   `display_name` (string): Человекочитаемое название типа пенсии.
    *   `description` (string): Краткое описание типа пенсии.
*   **Ответ (503 Service Unavailable)**: Если конфигурация не загружена.

#### GET /api/v1/pension_documents/{pension_type_id}

*   **Описание**: Возвращает список документов, требуемых для указанного типа пенсии.
*   **Параметры пути**:
    *   `pension_type_id` (string, обязательный): ID типа пенсии (из `/api/v1/pension_types`).
*   **Ответ (200 OK)**: Массив объектов [DocumentDetail](#documentdetail).
    ```json
    [
      {
        "id": "doc_passport_rf",
        "name": "Паспорт гражданина РФ",
        "description": "Основной документ, удостоверяющий личность гражданина РФ на территории РФ.",
        "is_critical": true,
        "condition_text": null,
        "ocr_type": "passport"
      },
      // ... другие документы
    ]
    ```
*   **Ответ (404 Not Found)**: Если требования для указанного `pension_type_id` не найдены.
*   **Ответ (503 Service Unavailable)**: Если конфигурация не загружена.

#### GET /api/v1/standard_document_names

*   **Описание**: Возвращает список всех уникальных стандартных названий документов, которые могут быть определены системой (например, при OCR). Используется для выбора `standardized_document_type` в [OtherDocumentData](#otherdocumentdata).
*   **Параметры**: Нет.
*   **Ответ (200 OK)**:
    ```json
    [
      "Военный билет",
      "Заявление о назначении пенсии",
      "Паспорт гражданина РФ",
      // ... другие стандартные названия документов
    ]
    ```
*   **Ответ (503 Service Unavailable)**: Если конфигурация не загружена.


### Работа с Делами (Cases)

#### POST /api/v1/cases

*   **Описание**: Создает новое пенсионное дело и ставит его в очередь на асинхронную обработку (RAG-анализ).
*   **Тело запроса**: [CaseDataInput](#casedatainput)
    ```json
    // Пример для страховой пенсии по старости
    {
      "personal_data": {
        "last_name": "Иванов",
        "first_name": "Иван",
        "middle_name": "Иванович",
        "birth_date": "1960-01-15",
        "snils": "123-456-789 00",
        "gender": "Мужской",
        "citizenship": "РФ",
        "dependents": 0
      },
      "pension_type": "retirement_standard", // ID из /api/v1/pension_types
      "work_experience": {
        "total_years": 35,
        "records": [
          {
            "organization": "ООО Ромашка",
            "position": "Инженер",
            "start_date": "1985-06-01",
            "end_date": "2020-01-14",
            "special_conditions": false
          }
        ]
      },
      "pension_points": 120.5,
      "submitted_documents": ["doc_passport_rf", "doc_snils", "doc_work_book"], // ID из /api/v1/pension_documents/{pension_type_id}
      "has_incorrect_document": false,
      "other_documents_extracted_data": [ // Данные, полученные от /api/v1/document_extractions/{task_id}
        {
          "identified_document_type": "Справка о заработной плате",
          "standardized_document_type": "Справка о зарплате за 60 месяцев до 2002 года",
          "extracted_fields": {"period": "1995-1999", "average_salary": "15000"},
          "multimodal_assessment": "Хорошее качество, текст четкий",
          "text_llm_reasoning": "Документ является справкой о зарплате, данные выглядят корректно..."
        }
      ]
    }
    ```
*   **Ответ (202 Accepted)**: [ProcessOutput](#processoutput)
    ```json
    {
      "case_id": 123,
      "final_status": "PROCESSING",
      "explanation": "Дело принято в обработку. Результаты будут доступны позже.",
      "confidence_score": null,
      "department_code": null,
      "error_info": null
    }
    ```
    Frontend должен использовать `case_id` для последующего запроса статуса через `/api/v1/cases/{case_id}/status`.
*   **Важно**: Этот эндпоинт инициирует фоновую задачу. Реальный анализ занимает время.

#### GET /api/v1/cases/{case_id}/status

*   **Описание**: Возвращает текущий статус и результаты обработки дела.
*   **Параметры пути**:
    *   `case_id` (integer, обязательный): ID дела.
*   **Ответ (200 OK)**: [ProcessOutput](#processoutput)
    *   Если `final_status` = "PROCESSING", обработка еще не завершена.
    *   Если `final_status` = "СООТВЕТСТВУЕТ" / "НЕ СООТВЕТСТВУЕТ", обработка завершена успешно. `explanation` будет содержать результат RAG-анализа.
    *   Если `final_status` = "ERROR_PROCESSING" / "FAILED", произошла ошибка. `explanation` и `error_info` могут содержать детали.
    ```json
    // Пример успешного завершения
    {
      "case_id": 123,
      "final_status": "СООТВЕТСТВУЕТ",
      "explanation": "Анализ системой RAG (уверенность: 95.0%):\n1. Оценка права на пенсию: Да\n2. Обоснование: ...\nИТОГ: СООТВЕТСТВУЕТ",
      "confidence_score": 0.95,
      "department_code": null,
      "error_info": null
    }
    ```
*   **Ответ (404 Not Found)**: Дело не найдено.

#### GET /api/v1/cases/{case_id}

*   **Описание**: Возвращает полную информацию о деле, включая все входные данные и результаты обработки.
*   **Параметры пути**:
    *   `case_id` (integer, обязательный): ID дела.
*   **Ответ (200 OK)**: [FullCaseData](#fullcasedata)
*   **Ответ (404 Not Found)**: Дело не найдено. Тело ответа: `{"error_code": "CASE_NOT_FOUND", "message": "Дело не найдено", "details": {"case_id": 123}}`.
*   **Ответ (500 Internal Server Error)**: Ошибка при парсинге/обработке данных дела из БД.

#### GET /api/v1/cases/history

*   **Описание**: Возвращает список всех дел с возможностью пагинации, отсортированных по дате создания (сначала новые).
*   **Параметры запроса (Query)**:
    *   `skip` (integer, необязательный, по умолчанию 0): Количество пропускаемых записей.
    *   `limit` (integer, необязательный, по умолчанию 10): Максимальное количество записей для возврата (максимум 100).
*   **Ответ (200 OK)**: Массив объектов [CaseHistoryEntry](#casehistoryentry).
*   **Ответ (500 Internal Server Error)**: Внутренняя ошибка при получении истории.

#### GET /api/v1/cases/{case_id}/document

*   **Описание**: Позволяет скачать сгенерированный документ (решение по делу) в формате PDF или DOCX.
*   **Параметры пути**:
    *   `case_id` (integer, обязательный): ID дела.
*   **Параметры запроса (Query)**:
    *   `format` (enum `DocumentFormat`, обязательный): Формат документа. Возможные значения: "pdf", "docx".
*   **Ответ (200 OK)**: Файл документа. Заголовки `Content-Type` и `Content-Disposition` будут установлены соответственно.
*   **Ответ (404 Not Found)**: Дело не найдено или документ для него еще не готов (например, если статус "PROCESSING").
*   **Ответ (400 Bad Request)**: Неверный формат документа или другая ошибка в параметрах.
*   **Ответ (500 Internal Server Error)**: Ошибка при генерации документа.

### Извлечение Данных из Документов (OCR/Vision)

Эти эндпоинты предназначены для обработки изображений документов (паспорт, СНИЛС, трудовая книжка, другие) и извлечения из них структурированных данных. Процесс асинхронный.

#### POST /api/v1/document_extractions

*   **Описание**: Загружает изображение документа для асинхронного извлечения данных.
*   **Тело запроса (`multipart/form-data`)**:
    *   `document_type` (enum `DocumentTypeToExtract`, обязательный): Тип документа. Возможные значения: "passport", "snils", "work_book", "other".
    *   `image` (file, обязательный): Файл изображения документа.
        *   **Допустимые MIME-типы**: `image/jpeg`, `image/png`, `image/gif`, `image/bmp`, `image/webp`.
        *   **Максимальный размер файла**: 10 MB.
    *   `ttl_hours` (integer, необязательный, по умолчанию 24): Время жизни задачи в часах (1-168). По истечении этого времени задача и ее результаты могут быть удалены.
*   **Ответ (202 Accepted)**: [OcrTaskSubmitResponse](#ocrtasksubmitresponse)
    ```json
    {
      "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "status": "PROCESSING",
      "message": "Документ принят на обработку. Проверьте статус позже."
    }
    ```
    Frontend должен сохранить `task_id` и периодически опрашивать статус задачи.
*   **Ответ (400 Bad Request)**: Неверный тип файла (MIME-тип).
*   **Ответ (413 Payload Too Large)**: Размер файла превышает 10MB.

#### GET /api/v1/document_extractions/{task_id}

*   **Описание**: Получает статус и результат задачи по извлечению данных из документа.
*   **Параметры пути**:
    *   `task_id` (string, обязательный): ID задачи, полученный от `POST /api/v1/document_extractions`.
*   **Ответ (200 OK)**: [OcrTaskStatusResponse](#ocrtaskstatusresponse)
    *   **Пример (COMPLETED - Паспорт)**:
        ```json
        {
          "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
          "status": "COMPLETED",
          "data": { // Структура PassportData
            "last_name": "Иванов",
            "first_name": "Иван",
            "middle_name": "Иванович",
            "birth_date": "1980-01-01",
            "sex": "Мужской",
            "birth_place": "г. Москва",
            "passport_series": "1234",
            "passport_number": "567890",
            "issue_date": "2010-01-01",
            "issuing_authority": "ОВД 'Хорошево-Мневники' г. Москвы",
            "department_code": "770-123"
          },
          "error": null
        }
        ```
    *   **Пример (COMPLETED - Трудовая книжка)**:
        ```json
        {
          "task_id": "...",
          "status": "COMPLETED",
          "data": { // Структура WorkBookData
            "records": [
              {"date_in": "2005-10-15", "date_out": "2010-03-01", "organization": "ООО Вектор", "position": "Менеджер"},
              {"date_in": "2010-04-01", "date_out": null, "organization": "АО Горизонт", "position": "Директор"}
            ],
            "calculated_total_years": 10.5 // Рассчитано на бэкенде
          },
          "error": null
        }
        ```
    *   **Пример (COMPLETED - Other Document)**:
        ```json
        {
          "task_id": "...",
          "status": "COMPLETED",
          "data": { // Структура OtherDocumentData
            "identified_document_type": "Справка о заработной плате", // От мультимодальной
            "standardized_document_type": "Справка о зарплате за 60 месяцев до 2002 года", // От текстовой LLM, если найдено соответствие
            "extracted_fields": {
              "employee_name": "Петров П.П.",
              "period_start": "01.01.1995",
              "period_end": "31.12.1999",
              "average_salary": "1500.00"
            },
            "multimodal_assessment": "Документ хорошего качества, текст читаем.",
            "text_llm_reasoning": "Это действительно справка о зарплате, содержит все необходимые реквизиты. Данные выглядят достоверно."
          },
          "error": null
        }
        ```
    *   **Пример (PROCESSING)**:
        ```json
        {
          "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
          "status": "PROCESSING",
          "data": null,
          "error": null
        }
        ```
    *   **Пример (FAILED)**:
        ```json
        {
          "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
          "status": "FAILED",
          "data": null,
          "error": {
            "detail": "Не удалось распознать документ.",
            "type": "VisionProcessingError"
          }
        }
        ```
*   **Ответ (404 Not Found)**: Задача не найдена.
*   **Примечание**: Результаты OCR/Vision задач кешируются на сервере на 30 минут.

#### GET /api/v1/tasks/stats

*   **Описание**: Получает статистику по статусам всех OCR/Vision задач.
*   **Параметры**: Нет.
*   **Ответ (200 OK)**: [TasksStatsResponse](#tasksstatsresponse)
    ```json
    {
      "total": 150,
      "pending": 10,         // Задачи в статусе PROCESSING, не просроченные
      "expired_processing": 2, // Задачи в статусе PROCESSING, но уже просроченные
      "status_specific_counts": {
        "PROCESSING": 12,    // Всего задач в статусе PROCESSING (pending + expired)
        "COMPLETED": 128,
        "FAILED": 10
      }
    }
    ```

### Служебные Эндпоинты

#### GET /

*   **Описание**: Корневой эндпоинт, возвращает приветственное сообщение.
*   **Ответ (200 OK)**: `{"message": "PFR-AI Backend is running!"}`

#### GET /api/v1/health

*   **Описание**: Проверяет работоспособность бэкенда и его зависимостей (БД, Ollama LLM, Ollama Vision, Neo4j).
*   **Параметры**: Нет.
*   **Ответ (200 OK)**: [HealthCheckResponse](#healthcheckresponse)
    ```json
    {
      "overall_status": "healthy", // или "unhealthy"
      "timestamp": "2023-10-27T10:00:00.000Z",
      "dependencies": [
        {"name": "database", "status": "ok", "message": "Соединение с БД успешно."},
        {"name": "Ollama_LLM", "status": "ok", "message": "Сервис Ollama_LLM (модель qwen3:latest) доступен."},
        {"name": "Ollama_Vision", "status": "error", "message": "Таймаут соединения с Ollama_Vision."},
        {"name": "neo4j", "status": "ok", "message": "Соединение с Neo4j успешно."}
      ]
    }
    ```

---

## 8. Фоновые Задачи

Некоторые операции выполняются асинхронно в фоновом режиме:

1.  **Обработка пенсионного дела (`POST /api/v1/cases`)**:
    *   После создания дела, RAG-анализ запускается в фоне.
    *   Frontend должен периодически опрашивать эндпоинт `/api/v1/cases/{case_id}/status` для получения результатов.
    *   Результаты RAG-анализа кешируются на 1 час. Если приходит идентичный запрос (тот же тип пенсии и хеш данных дела), результат может быть взят из кеша.

2.  **Извлечение данных из документов (`POST /api/v1/document_extractions`)**:
    *   Распознавание текста и извлечение структурированных данных из изображений происходит в фоне.
    *   Frontend должен опрашивать `/api/v1/document_extractions/{task_id}`.
    *   Результаты успешно обработанных или ошибочных задач кешируются на 30 минут.
    *   Задачи имеют TTL (по умолчанию 24 часа), после чего они удаляются.

3.  **Очистка просроченных OCR-задач**:
    *   Сервер периодически (раз в час) удаляет OCR-задачи, у которых истек TTL. Это внутренняя задача, не влияющая напрямую на frontend.

---

## 9. Важные Замечания для Frontend

*   **Асинхронность**: Ключевые операции (создание дела, OCR) асинхронны. Реализуйте механизм опроса (polling) для получения их результатов.
*   **Валидация на клиенте**: По возможности, проводите валидацию данных на стороне клиента перед отправкой (например, формат СНИЛС, заполнение обязательных полей, корректность дат), чтобы улучшить UX и снизить нагрузку на сервер.
*   **Справочники**: Загружайте списки типов пенсий (`/api/v1/pension_types`) и требуемых документов (`/api/v1/pension_documents/{pension_type_id}`) при инициализации соответствующих форм или разделов приложения. Список стандартных имен документов (`/api/v1/standard_document_names`) может быть полезен для отображения или автодополнения при работе с "другими" документами.
*   **Размер файлов**: Ограничение на размер загружаемых изображений для OCR - 10MB. Информируйте пользователя об этом.
*   **Типы файлов**: Для OCR принимаются только изображения (`image/jpeg`, `image/png` и т.д.).
*   **Формат дат**: Все даты в API передаются и принимаются в формате `YYYY-MM-DD`. Даты-время в формате ISO 8601.
*   **Кеширование**: Бэкенд кеширует результаты RAG-анализа и OCR-задач. Это может влиять на скорость получения повторных ответов.
*   **Обработка `other_documents_extracted_data`**: Данные, полученные из эндпоинта `/api/v1/document_extractions/{task_id}` для типа `other`, должны быть переданы в поле `other_documents_extracted_data` при создании/обновлении дела (`POST /api/v1/cases`). Это позволит RAG-системе учесть информацию из этих документов.
*   **`department_code` в `ProcessOutput`**: Это поле зарезервировано для будущего использования и пока может быть `null`.
*   **Локализация**: Все текстовые описания и сообщения от API приходят на русском языке.

```